/*!
* Publisher – Javascript Pub/Sub library
* @license MIT
* © 2015–present Frank Kudermann @ alphanull
*/
let e=-1;const i={async:!0,handleExceptions:!1,lenientUnsubscribe:!1},n=new Map,o=new Map,t=new Map;function s(e){if(!e)throw new Error("Publisher configure: no options specified");void 0!==e.async&&(i.async=e.async),void 0!==e.handleExceptions&&(i.handleExceptions=e.handleExceptions),void 0!==e.lenientUnsubscribe&&(i.lenientUnsubscribe=e.lenientUnsubscribe)}function r(e,n,s={}){if(!0===s.persist&&t.set(e,{data:n,options:s}),e.indexOf("*")>-1)throw new Error("Publish topic cannot contain any wildcards.");const r=p(e.split("/"),n,s,o,e);let c;r.sort(((e,i)=>e.priority===i.priority?e.position-i.position:e.priority>i.priority?-1:1));const a=void 0===s.async?i.async:s.async;for(;c=r.shift();)if(a)setTimeout(d.bind(null,c,e,n,s),0);else if(!1===d(c,e,n,s)&&!1!==s.cancelable)return!1;return!0}function c(s,r,c={}){const a=e+=1;if(void 0===s)throw new Error('Subscribe failed - "undefined" Topic.');if(s.includes("undefined"))throw new Error(`Subscribe for '${s}' failed - found 'undefined' in topic, this is almost always an error: ${a}`);if(void 0===r)throw new Error(`Subscribe for '${s}' failed - "undefined" Handler`);const l={token:a,topic:s,handler:r,options:c};if(n.set(a,l),f(s.split("/"),l,o),!0!==c.persist)return a;const p=new RegExp(`^${s.replace("*","(.+)")}(/.+)?$`);for(const[e,n]of t){if(e.match(p)){if(void 0===n.options.async?i.async:n.options.async)setTimeout(d.bind(null,l,e,n.data,c),0);else if(!1===d(l,e,n.data,c)&&!0===c.cancelable)break}}return a}function a(e,t,s){const r=t===Boolean(t)?t:s,c=void 0===r?i.lenientUnsubscribe:r,a=e=>{const i=n.get(e);if(void 0===i){if(!0===c)return;throw new Error(`Unsubscribe failed. Did not find subscriber for token: ${e}`)}u(i.topic.split("/"),i,o),n.delete(e)};if(void 0===e){if(!0===c)return;throw new Error("Unsubscribe failed. No Arguments specified.")}if(Array.isArray(e))e.forEach((e=>a(e)));else if(!isNaN(parseFloat(e))&&isFinite(e))a(e);else{if(void 0===t){if(!0===c)return;throw new Error(`Unsubscribe failed. No handler for topic based unsubscribe specified ${e}`)}for(const[,i]of n)if(i.handler===t&&i.topic===e){u(e.split("/"),i,o),n.delete(i.token);break}}}function l(e){t.delete(e)}function d(e,o,t,s={}){if(!n.has(e.token))return;e.options.invocations>0&&(e.options.invocations-=1,e.options.invocations<=0&&a(e.token));const{handler:r}=e;if(!0!==s.handleExceptions&&!0!==i.handleExceptions)return r(t,o);try{return r(t,o)}catch(e){window.console&&window.console.error&&window.console.error("Exception while executing publish handler: ",e)}}function p(e,n,o={},t,s,r=[]){const c=t.get("subscribers")||new Map,a=t.get("topics");for(const[,e]of c){const{condition:t}=e.options;(void 0===t||"[object Function]"===Object.prototype.toString.call(t)&&!0===t(n,s))&&(e.position=r.push(e),e.priority=e.options.priority||0,e.async=Boolean(o.async||e.options.async||i.async))}if(e.length&&a){const i=a.get(e[0]),t=a.get("*");void 0===t&&void 0===i||(void 0!==t&&p(e.slice(1,e.length),n,o,t,s,r),void 0!==i&&p(e.slice(1,e.length),n,o,i,s,r),e.shift())}return r}function f(e,i,n){const[o]=e;void 0===n.get("topics")&&n.set("topics",new Map);const t=n.get("topics");let s=t.get(o);void 0===s&&(s=new Map,t.set(o,s)),e.length<2?(void 0===s.get("subscribers")&&s.set("subscribers",new Map),s.get("subscribers").set(i.token,i)):(e.shift(),f(e,i,s))}function u(e,i,n){const[o]=e,t=n.get("topics"),s=t.get(o),r=s.get("subscribers");e.length<2?(r.delete(i.token),0===r.size&&s.delete("subscribers")):(e.shift(),u(e,i,s)),s.has("topics")&&0===s.get("topics").size&&s.delete("topics"),0===t.get(o).size&&t.delete(o)}export{s as configure,r as publish,l as removePersistentMessage,c as subscribe,a as unsubscribe};
