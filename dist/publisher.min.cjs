/*!
* Publisher – Javascript Pub/Sub library
* @license MIT
* © 2015–present Frank Kudermann @ alphanull
*/
!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?n(exports):"function"==typeof define&&define.amd?define(["exports"],n):n((e="undefined"!=typeof globalThis?globalThis:e||self).publisher={})}(this,(function(e){"use strict";
/**
     * The publisher module. Provides pub/sub functionality with extensive wildcard support, async/sync publishing, priority and invocation options, content based filtering & more.
     * @module publisher
     * @author Frank Kudermann / alphanull
     * @version 1.6.0
     * @license MIT
     */const n={async:!0,handleExceptions:!1,lenientUnsubscribe:!1};let i=-1;const t=new Map,o=new Map,s=new Map;function r(e){"function"==typeof queueMicrotask?queueMicrotask(e):"function"==typeof Promise?Promise.resolve().then(e):setTimeout(e,0)}function c(e){return void 0===e}function f(e,i,s){const r=i===Boolean(i)?i:s,f=c(r)?n.lenientUnsubscribe:r,a=e=>{const n=t.get(e);if(c(n)){if(!0===f)return;throw new Error(`Unsubscribe failed. Did not find subscriber for token: ${e}`)}u(n.topic.split("/"),n,o),t.delete(e)};if(c(e)){if(!0===f)return;throw new Error("Unsubscribe failed. No Arguments specified.")}if(Array.isArray(e))e.forEach((e=>a(e)));else if(!isNaN(parseFloat(e))&&isFinite(e))a(e);else{if(c(i)){if(!0===f)return;throw new Error(`Unsubscribe failed. No handler for topic based unsubscribe specified ${e}`)}for(const[,n]of t)if(n.handler===i&&n.topic===e){u(e.split("/"),n,o),t.delete(n.token);break}}}function a(e,i,o,s={}){if(!t.has(e.token))return;e.options.invocations>0&&(e.options.invocations-=1,e.options.invocations<1&&f(e.token));const{handler:r}=e;if(!0!==s.handleExceptions&&!0!==n.handleExceptions)return!0===e.options.topicArg?r(i,o):r(o,i);try{return!0===e.options.topicArg?r(i,o):r(o,i)}catch(e){window.console&&window.console.error&&window.console.error("Exception while executing publish handler: ",e)}}function l(e,i,t={},o,s,r=[]){const f=o.get("subscribers")||new Map,a=o.get("topics");for(const[,e]of f){const{condition:o,topicArg:f}=e.options;(c(o)||(!0===f?!0===o(s,i):!0===o(i,s)))&&(e.position=r.push(e),e.priority=e.options.priority||0,e.async=Boolean(t.async||e.options.async||n.async))}if(e.length&&a){const n=a.get(e[0]),o=a.get("*");c(o)&&c(n)||(c(o)||l(e.slice(1,e.length),i,t,o,s,r),c(n)||l(e.slice(1,e.length),i,t,n,s,r),e.shift())}return r}function p(e,n,i){const[t]=e;c(i.get("topics"))&&i.set("topics",new Map);const o=i.get("topics");let s=o.get(t);c(s)&&(s=new Map,o.set(t,s)),e.length<2?(c(s.get("subscribers"))&&s.set("subscribers",new Map),s.get("subscribers").set(n.token,n)):(e.shift(),p(e,n,s))}function u(e,n,i){const[t]=e,o=i.get("topics"),s=o.get(t),r=s.get("subscribers");e.length<2?(r.delete(n.token),0===r.size&&s.delete("subscribers")):(e.shift(),u(e,n,s)),s.has("topics")&&0===s.get("topics").size&&s.delete("topics"),0===o.get(t).size&&o.delete(t)}e.configure=function({async:e,handleExceptions:i,lenientUnsubscribe:t}={}){c(e)||(n.async=e),c(i)||(n.handleExceptions=i),c(t)||(n.lenientUnsubscribe=t)},e.publish=function(e,i,t={}){if(!0===t.persist&&s.set(e,{data:i,options:t}),e.indexOf("*")>-1)throw new Error("Publish topic cannot contain any wildcards.");const f=l(e.split("/"),i,t,o,e);let p;f.sort(((e,n)=>e.priority===n.priority?e.position-n.position:e.priority>n.priority?-1:1));const u=c(t.async)?n.async:t.async;for(;p=f.shift();)if(u)r(a.bind(null,p,e,i,t));else if(!1===a(p,e,i,t)&&!1!==t.cancelable)return!1;return!0},e.removePersistentMessage=function(e){s.delete(e)},e.subscribe=function(e,f,l={}){const u=i+=1;if(c(e))throw new Error("Subscribe failed - undefined Topic.");if(e.includes("undefined"))throw new Error(`Subscribe for '${e}' failed - found 'undefined' in topic, this is almost always an error: ${u}`);if(c(f))throw new Error(`Subscribe for '${e}' failed - undefined Handler`);const d={token:u,topic:e,handler:f,options:l};if(t.set(u,d),p(e.split("/"),d,o),!0!==l.persist)return u;const b=new RegExp(`^${e.replace("*","(.+)")}(/.+)?$`);for(const[e,i]of s){if(e.match(b)){if(c(i.options.async)?n.async:i.options.async)r(a.bind(null,d,e,i.data,l));else if(!1===a(d,e,i.data,l)&&!0===l.cancelable)break}}return u},e.unsubscribe=f}));
